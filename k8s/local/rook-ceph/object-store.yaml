# Rook-Ceph Object Store (S3 Gateway) Configuration
# This creates an S3-compatible RADOS Gateway (RGW) service
#
# Usage:
#   kubectl apply -f object-store.yaml
#
# Prerequisites:
#   - Rook-Ceph cluster must be healthy
#   - Check: kubectl -n rook-ceph get cephcluster

---
apiVersion: ceph.rook.io/v1
kind: CephObjectStore
metadata:
  name: s3-store
  namespace: rook-ceph
spec:
  # Metadata pool configuration
  metadataPool:
    failureDomain: host
    replicated:
      size: 3
      requireSafeReplicaSize: true
    parameters:
      compression_mode: none
  
  # Data pool configuration
  dataPool:
    failureDomain: host
    replicated:
      size: 3
      requireSafeReplicaSize: true
    parameters:
      compression_mode: none
  
  # Preserve pools on object store deletion (for safety)
  preservePoolsOnDelete: true
  
  # RGW gateway configuration
  gateway:
    # Number of RGW instances
    instances: 2
    
    # Gateway port
    port: 80
    
    # Enable secure port (requires SSL certificates)
    # securePort: 443
    # sslCertificateRef: rgw-ssl-cert
    
    # Resource requests/limits
    resources:
      limits:
        cpu: "2000m"
        memory: "2Gi"
      requests:
        cpu: "1000m"
        memory: "1Gi"
    
    # Priority class
    priorityClassName: system-cluster-critical
    
    # Placement (optional - spread across nodes)
    placement:
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - rook-ceph-rgw
            topologyKey: kubernetes.io/hostname

---
# Service to expose the S3 gateway
apiVersion: v1
kind: Service
metadata:
  name: rook-ceph-rgw-s3-store
  namespace: rook-ceph
  labels:
    app: rook-ceph-rgw
    rgw: s3-store
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  # Uncomment for HTTPS:
  # - name: https
  #   port: 443
  #   protocol: TCP
  #   targetPort: 443
  selector:
    app: rook-ceph-rgw
    rgw: s3-store

---
# Optional: Ingress for external access to S3
# Uncomment to expose S3 externally:
# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: rook-ceph-rgw-s3
#   namespace: rook-ceph
#   annotations:
#     nginx.ingress.kubernetes.io/proxy-body-size: "0"
#     nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
# spec:
#   ingressClassName: nginx
#   rules:
#   - host: s3.example.com
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#           service:
#             name: rook-ceph-rgw-s3-store
#             port:
#               name: http
#   tls:
#   - hosts:
#     - s3.example.com
#     secretName: s3-tls-cert

---
# Storage class for RGW bucket provisioning (optional)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rook-ceph-bucket
provisioner: rook-ceph.ceph.rook.io/bucket
parameters:
  objectStoreName: s3-store
  objectStoreNamespace: rook-ceph
  region: us-east-1
reclaimPolicy: Delete
