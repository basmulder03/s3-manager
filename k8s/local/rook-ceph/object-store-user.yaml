# Rook-Ceph Object Store User (S3 Credentials)
# This creates an S3 user with access/secret keys for S3 Manager
#
# Usage:
#   kubectl apply -f object-store-user.yaml
#
# Prerequisites:
#   - Object store must be created and healthy
#   - Check: kubectl -n rook-ceph get cephobjectstore
#
# After creation, retrieve credentials:
#   kubectl -n rook-ceph get secret rook-ceph-object-user-s3-store-s3-manager -o jsonpath='{.data.AccessKey}' | base64 -d
#   kubectl -n rook-ceph get secret rook-ceph-object-user-s3-store-s3-manager -o jsonpath='{.data.SecretKey}' | base64 -d

---
apiVersion: ceph.rook.io/v1
kind: CephObjectStoreUser
metadata:
  name: s3-manager
  namespace: rook-ceph
spec:
  # Reference to the object store
  store: s3-store
  
  # Display name for the user
  displayName: "S3 Manager Application User"
  
  # Quota settings (optional)
  quotas:
    # Maximum number of buckets (0 = unlimited)
    maxBuckets: 100
    # Maximum size in bytes (0 = unlimited)
    # maxSize: 107374182400  # 100GB
    # Maximum objects (0 = unlimited)
    # maxObjects: 1000000

---
# ConfigMap with S3 endpoint information for easy reference
apiVersion: v1
kind: ConfigMap
metadata:
  name: s3-manager-rook-ceph-config
  namespace: rook-ceph
data:
  # S3 endpoint URL (internal cluster access)
  S3_ENDPOINT: "http://rook-ceph-rgw-s3-store.rook-ceph.svc.cluster.local:80"
  S3_REGION: "us-east-1"
  S3_USE_SSL: "false"
  S3_VERIFY_SSL: "false"
  
  # Instructions for retrieving credentials
  README.txt: |
    To retrieve S3 credentials for S3 Manager:
    
    Access Key:
    kubectl -n rook-ceph get secret rook-ceph-object-user-s3-store-s3-manager -o jsonpath='{.data.AccessKey}' | base64 -d
    
    Secret Key:
    kubectl -n rook-ceph get secret rook-ceph-object-user-s3-store-s3-manager -o jsonpath='{.data.SecretKey}' | base64 -d
    
    These credentials are stored in the secret:
    rook-ceph-object-user-s3-store-s3-manager
    
    Use these to configure S3 Manager deployment.

---
# Helper Job to create a test bucket
apiVersion: batch/v1
kind: Job
metadata:
  name: create-test-bucket
  namespace: rook-ceph
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: aws-cli
        image: amazon/aws-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for S3 credentials to be available..."
          while [ ! -f /tmp/credentials/AccessKey ] || [ ! -f /tmp/credentials/SecretKey ]; do
            sleep 2
          done
          
          export AWS_ACCESS_KEY_ID=$(cat /tmp/credentials/AccessKey)
          export AWS_SECRET_ACCESS_KEY=$(cat /tmp/credentials/SecretKey)
          export AWS_DEFAULT_REGION=us-east-1
          
          echo "Creating test bucket: test-bucket"
          aws --endpoint-url=http://rook-ceph-rgw-s3-store.rook-ceph.svc.cluster.local:80 \
              s3 mb s3://test-bucket || echo "Bucket may already exist"
          
          echo "Uploading test files..."
          echo "Hello from Rook-Ceph S3!" > /tmp/test-file.txt
          aws --endpoint-url=http://rook-ceph-rgw-s3-store.rook-ceph.svc.cluster.local:80 \
              s3 cp /tmp/test-file.txt s3://test-bucket/test-file.txt
          
          echo "Listing buckets:"
          aws --endpoint-url=http://rook-ceph-rgw-s3-store.rook-ceph.svc.cluster.local:80 \
              s3 ls
          
          echo "Test bucket created successfully!"
        volumeMounts:
        - name: s3-credentials
          mountPath: /tmp/credentials
          readOnly: true
      volumes:
      - name: s3-credentials
        secret:
          secretName: rook-ceph-object-user-s3-store-s3-manager
