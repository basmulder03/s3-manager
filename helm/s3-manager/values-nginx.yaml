# Example values for S3 Manager with NGINX Ingress and oauth2-proxy
# Deploy with: helm install s3-manager ./helm/s3-manager -f ./helm/s3-manager/values-nginx.yaml

# NOTE: NGINX Ingress is supported. Envoy Gateway is the recommended default for new deployments.
# See values-envoy-keycloak.yaml or values-envoy-azure.yaml for modern alternatives.

replicaCount: 2

image:
  repository: your-registry/s3-manager
  pullPolicy: IfNotPresent
  tag: 'latest'

service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# Ingress Configuration - NGINX Ingress (Alternative)
ingress:
  enabled: true
  type: nginx # Use NGINX Ingress

  className: nginx # IngressClass name
  hostname: s3-manager.example.com

  tls:
    enabled: true
    secretName: s3-manager-tls
    certManager:
      enabled: true
      issuerName: letsencrypt-prod
      issuerKind: ClusterIssuer

  # NGINX Ingress specific configurations
  nginx:
    # OIDC via oauth2-proxy (requires separate deployment)
    oauth2Proxy:
      enabled: true
      url: http://oauth2-proxy.auth-system.svc.cluster.local
      signInUrl: https://s3-manager.example.com/oauth2/start

    # Additional annotations for NGINX Ingress
    annotations:
      # Rate limiting
      nginx.ingress.kubernetes.io/limit-rps: '100'
      nginx.ingress.kubernetes.io/limit-connections: '10'

      # Security headers
      nginx.ingress.kubernetes.io/configuration-snippet: |
        more_set_headers "X-Frame-Options: SAMEORIGIN";
        more_set_headers "X-Content-Type-Options: nosniff";
        more_set_headers "X-XSS-Protection: 1; mode=block";
        more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains";
        more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';";

      # Timeouts
      nginx.ingress.kubernetes.io/proxy-connect-timeout: '60'
      nginx.ingress.kubernetes.io/proxy-send-timeout: '60'
      nginx.ingress.kubernetes.io/proxy-read-timeout: '60'

      # Body size limit
      nginx.ingress.kubernetes.io/proxy-body-size: '100m'

      # CORS (if needed)
      # nginx.ingress.kubernetes.io/enable-cors: "true"
      # nginx.ingress.kubernetes.io/cors-allow-origin: "https://s3-manager.example.com"
      # nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE"
      # nginx.ingress.kubernetes.io/cors-allow-credentials: "true"

# OIDC Secret - for oauth2-proxy configuration
oidcSecret:
  create: true
  name: s3-manager-oidc-secret
  # Set these values via --set flags or use external-secrets
  clientSecret: '' # REQUIRED: Set via --set oidcSecret.clientSecret=<value>

# Application Configuration
# When using oauth2-proxy, the application still needs OIDC config for token validation
config:
  oidcProvider: keycloak # or azure, google

  # Keycloak settings (example)
  keycloak:
    authority: https://keycloak.example.com/realms/s3-manager
    clientId: s3-manager-client
    redirectUri: https://s3-manager.example.com/auth/callback
    logoutUri: https://s3-manager.example.com/auth/logout
    scope: 'openid profile email roles'

    # Role mapping from Keycloak roles to app permissions
    roleMapping:
      S3-Admin:
        - view
        - write
        - delete
      S3-Editor:
        - view
        - write
      S3-Viewer:
        - view
      S3-Property-Admin:
        - view
        - write
        - manage_properties

  # S3/LocalStack Configuration
  s3:
    endpoint: http://localstack:4566
    region: us-east-1
    bucket: my-bucket
    accessKeyId: test
    secretAccessKey: test
    useSSL: false

# Resource limits
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

# Autoscaling
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# Health checks
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5

# Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# Node selection
nodeSelector: {}
tolerations: []
affinity: {}

---
# IMPORTANT: You must deploy oauth2-proxy separately for NGINX Ingress OIDC
# Example oauth2-proxy deployment with Keycloak:
#
# helm repo add oauth2-proxy https://oauth2-proxy.github.io/manifests
# helm install oauth2-proxy oauth2-proxy/oauth2-proxy \
#   --namespace auth-system \
#   --set config.clientID=s3-manager-client \
#   --set config.clientSecret=<client-secret> \
#   --set config.cookieSecret=$(openssl rand -base64 32) \
#   --set extraArgs.provider=keycloak-oidc \
#   --set extraArgs.oidc-issuer-url=https://keycloak.example.com/realms/s3-manager \
#   --set extraArgs.redirect-url=https://s3-manager.example.com/oauth2/callback \
#   --set extraArgs.email-domain=* \
#   --set extraArgs.whitelist-domain=.example.com \
#   --set extraArgs.cookie-domain=.example.com \
#   --set extraArgs.cookie-secure=true \
#   --set extraArgs.upstream=static://202
#
# For Azure AD, use:
#   --set extraArgs.provider=azure \
#   --set extraArgs.azure-tenant=<tenant-id>
#
# For Google, use:
#   --set extraArgs.provider=google
